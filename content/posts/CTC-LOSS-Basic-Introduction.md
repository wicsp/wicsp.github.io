---
title: "CTC Loss: A Basic Introduction"
date: 2019-12-25T21:31:02+08:00
tags:
  - ML
  - CTC
categories:
  - Machine Learning
---


在语音识别中，我们的数据集是音频文件和其对应的文本，不幸的是，音频文件和文本很难再单词的单位上对齐。除了语言识别，在 OCR，机器翻译中，都存在类似的 Sequence to Sequence 结构，同样也需要在预处理操作时进行对齐，但是这种对齐有时候是非常困难的。如果不使用对齐而直接训练模型时，由于人的语速的不同，或者字符间距离的不同，导致模型很难收敛。

CTC(Connectionist Temporal Classification)是一种避开输入与输出的一种方式，是非常适合语音识别或者 OCR 这种应用的。

<!-- more -->

## 算法详解（以语音识别为例）

给定输入 X ，CTC 输出每个可能输出及其条件概率。问题的关键是 CTC 的输出概率是如何考虑 X 和 Y 之间的对齐的，这种对齐也是构建损失函数的基础。所以，首先我们分析 CTC 的对齐方式，然后我们在分析 CTC 的损失函数的构造。

### 对齐

需要注意的是，CTC 本身是不需要对齐的，但是我们需要知道 X 的输出路径和最终输出结果的对应关系，因为在 CTC 中，多个输出路径可能对应一个输出结果，举例来理解。例如在 OCR 的任务中，输入 X 是含有“CAT”的图片，输出 Y 是文本[C, A, T]。将 X 分割成若干个时间片，每个时间片得到一个输出，一个最简答的解决方案是合并连续重复出现的字母，如图：

![](https://pic4.zhimg.com/80/v2-c6060dd92a0036ee9ac7d246b145c097_hd.jpg)

这个问题有两个缺点：

- 几乎不可能将 X 的每个时间片都和输出 Y 对应上，例如 OCR 中字符的间隔，语音识别中的停顿;
- 不能处理有连续重复字符出现的情况，例如单词“HELLO”，按照上面的算法，输出的是“HELO”而非“HELLO”。

为了解决上面的问题，CTC 引入了空白字符 \epsilon ，例如 OCR 中的字符间距，语音识别中的停顿均表示为 \epsilon 。所以，CTC 的对齐涉及去除重复字母和去除 \epsilon 两部分

![](https://pic2.zhimg.com/80/v2-19628be2860d7c47703c93323a80ed71_hd.jpg)

这种对齐方式有三个特征：

- X 与 Y 之间的时间片映射是单调的，即如果 X 向前移动一个时间片， Y 保持不动或者也向前移动一个时间片；
- X 与 Y 之间的映射是多对一的，即多个输出可能对应一个映射，反之则不成立，所以也有了特征 3；
- X 的长度大于等于 Y 的长度。

### 损失函数

CTC 的时间片的输出和输出序列的映射如图

![](https://pic3.zhimg.com/80/v2-33c568826c1ea577b2dd9ad5650cb9ee_hd.jpg)

也就是说，对应标签 Y ，其关于输入 X 的后验概率可以表示为所有映射为 Y 的路径之和，我们的目标就是最大化 Y 关于 x = y 的后验概率 P(Y|X) 。假设每个时间片的输出是相互独立的，则路径的后验概率是每个时间片概率的累积，公式及其详细含义如图

![](https://pic2.zhimg.com/80/v2-a67c5a14189f26915c9533ed8ca779e1_hd.jpg)

上面的 CTC 算法存在性能问题，对于一个时间片长度为 T 的 N 分类任务，所有可能的路径数为 T^N ，在很多情况下，这几乎是一个宇宙级别的数字，用于计算 Loss 几乎是不现实的。在 CTC 中采用了动态规划的思想来对查找路径进行剪枝，算法的核心思想是如果路径 \pi_1 和路径 \pi_2 在时间片 t 之前的输出均相等，我们就可以提前合并他们，如图

![](https://pic4.zhimg.com/80/v2-87e7590c1a257520d631276879c3693b_hd.jpg)

其中，横轴的单位是 X 的时间片，纵轴的单位是 Y 插入 \epsilon 的序列 Z 。例如对于单词“ZOO”，插入 \epsilon 后为：

![](https://www.zhihu.com/equation?tex=Z+%3D%5C%7B%5Cepsilon%2C+Z%2C+%5Cepsilon%2C+O%2C+%5Cepsilon%2C+O%2C+%5Cepsilon%5C%7D%5Ctag%7B2%7D)
